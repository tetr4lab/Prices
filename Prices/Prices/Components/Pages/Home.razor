@inherits ItemListBase<Price>

@page "/"

<PageTitle>Prices Home</PageTitle>

@if (DataSet.IsUnavailable) {
    <MudAlert Severity="Severity.Error" Elevation="3">Unable to connect to any of the specified database management hosts.</MudAlert>
} else if (!DataSet.IsReady || items == null) {
    <MudProgressCircular Indeterminate="true" />
} else {
    if (items.Count > 0) {
        <MudTable Items="items" Dense Hover Breakpoint="Breakpoint.Xs" @ref="_table"
                Filter="new Func<Price, bool> (FilterFunc)"
                SortLabel="⇅"
                AllowUnsorted="true"
                @bind-SelectedItem="selectedItem"
                CommitEditTooltip="保存"
                CancelEditTooltip="取消"
                RowEditPreview="Edit"
                RowEditCancel="Cancel"
                RowEditCommit="Commit"
                GroupBy="groupDefinition"
                GroupHeaderStyle="background-color:var(--mud-palette-background-gray);"
                ReadOnly="false"
                CanCancelEdit="true"
                IsEditRowSwitchingBlocked="true"
                ApplyButtonPosition="TableApplyButtonPosition.End"
                EditButtonPosition="TableEditButtonPosition.End"
                EditTrigger="TableEditTrigger.EditButton">
            <HeaderContent>
                @{ CheckPageChangedAndCollapse (); }
                <MudTh>@(Price.Label [nameof (Price.Category)])</MudTh>
                <MudTh>@(Price.Label [nameof (Price.ProductId)])</MudTh>
                <MudTh>@(Price.Label [nameof (Price.StoreId)])</MudTh>
                <MudTh Class="align-right" Style="width: 9em;">
                    @(Price.Label [nameof (Price.PriceWithTax)])
                    <MudButton Style="min-width: 3em;" Size="Size.Small" OnClick="() => DataSet.TaxExcluded = !DataSet.TaxExcluded">
                        @($"(税{(DataSet.TaxExcluded ? "抜" : "込")})")
                    </MudButton>
                </MudTh>
                <MudTh Class="align-right" Style="width: 7em;">@(Price.Label [nameof (Price.Quantity)])</MudTh>
                <MudTh>@(Price.Label [nameof (Price.Remarks)])</MudTh>
                @{ lastCategoryId = lastProductId = lastStoreId = 0; }
            </HeaderContent>
            <GroupHeaderTemplate>
                @{
                    var price = context.Items.First ();
                    var (category, product, store) = GetRelations (price);
                }
                <MudTd DataLabel="@(Price.Label[nameof(Price.Category)])">@(category?.Name)</MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.ProductId)])">@(product?.Name)</MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.StoreId)])">@(store?.Name)</MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@($"{Price.Label[nameof(Price.PriceWithTax)]}(税{(DataSet.TaxExcluded ? "抜" : "込")})")">
                    @if (price.PriceWithTax == null) {
                        @("未記入")
                    } else {
                        <MudTooltip Text="@($"{Price.Label[nameof(Price.Confirmed)]}: {price.Confirmed?.ToShortDateString ()}")">
                            @($"¥{(DataSet.TaxExcluded ? price.PriceWithoutTax : price.PriceWithTax):#,0}")
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Price.Label[nameof(Price.Quantity)])">
                    <MudTooltip Text="@(price.UnitPrice == null ? "未記入" : $"¥{price.UnitPrice}")" Duration="1000">
                        @(price.Quantity == null ? "未記入" : $"{price.Quantity:#,0}{product?.Unit}")
                    </MudTooltip>
                </MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.Remarks)])">@(price.Remarks)</MudTd>
            </GroupHeaderTemplate>
            <GroupFooterTemplate>
                @{
                    var price = context.Items.First ();
                    var filterText = $"p{price.ProductId}.";
                }
                <MudTd colspan="5" Style="border-right:none;" />
                <MudTd>
                    <MudStack Row>
                        <MudTooltip Text="この製品で絞り込み" Duration="1000">
                            <MudIconButton Disabled="@(FilterText == filterText)" Size="Size.Small" Icon="@Icons.Material.Outlined.FilterList" OnClick="@(async () => { await SetFilterText.InvokeAsync (filterText); NavManager.NavigateTo ("./"); })" />
                        </MudTooltip>
                        <MudSpacer />
                        <MudTooltip Text="この製品の価格を追加" Duration="1000">
                            <MudIconButton Disabled="isAdding" Size="Size.Small" Icon="@Icons.Material.Outlined.Add" OnClick="() => AddSameItem (price.ProductId, price.StoreId)" />
                        </MudTooltip>
                    </MudStack>
                </MudTd>
            </GroupFooterTemplate>
            <RowTemplate>
                @{ var (category, product, store) = GetRelations (context); }
                <MudHidden Breakpoint="Breakpoint.Xs">
                    <MudTd colspan="2" />
                </MudHidden>
                <MudTd DataLabel="@(Price.Label[nameof(Price.StoreId)])">@(store?.Name)</MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@($"{Price.Label[nameof(Price.PriceWithTax)]}(税{(DataSet.TaxExcluded ? "抜" : "込")})")">
                    @if (context.PriceWithTax == null) {
                        @("未記入")
                    } else {
                        var price = DataSet.TaxExcluded ? context.PriceWithoutTax : context.PriceWithTax;
                        <MudTooltip Text="@($"{Price.Label[nameof(Price.Confirmed)]}: {context.Confirmed?.ToShortDateString ()}")">
                            @($"¥{price:#,0}")
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Price.Label[nameof(Price.Quantity)])">
                    <MudTooltip Text="@(context.UnitPrice == null ? "未記入" : $"¥{context.UnitPrice}")" Duration="1000">
                        @(context.Quantity == null ? "未記入" : $"{context.Quantity:#,0}{product?.Unit}")
                    </MudTooltip>
                </MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.Remarks)])">@context.Remarks</MudTd>
            </RowTemplate>
            <RowEditingTemplate>
                @{ var (category, product, store) = GetRelations (context); }
                <MudTd colspan="2">
                    <MudStack Row>
                        <MudSpacer />
                        @{ var disable = context.ReferenceCount (DataSet) > 0; }
                        <MudTooltip Text="@(disable ? "最後につき削除不可" : "この価格を削除")" Duration="1000">
                            <MudIconButton Disabled="@(disable)" Size="Size.Small" Icon="@Icons.Material.Outlined.DeleteForever" Class="pa-0" OnClick="() => DeleteItem (context)" />
                        </MudTooltip>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.StoreId)])">
                    <MudSelect Typo="Typo.body2" T="long" Clearable="false" @bind-Value="context.StoreId">
                        @foreach (var store in DataSet.Stores) {
                            <MudSelectItem Value="store.Id">@(store.Name)</MudSelectItem>
                        }
                    </MudSelect>
                </MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Price.Label[nameof(Price.PriceWithTax)])">
                    @if (DataSet.TaxExcluded) {
                        <MudTextField Typo="Typo.body2" T="float?" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.CurrencyYen" IconSize="Size.Small" @bind-Value="context.PriceWithoutTax" />
                    } else {
                        <MudTextField Typo="Typo.body2" T="float?" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.CurrencyYen" IconSize="Size.Small" @bind-Value="context.PriceWithTax" />
                    }
                    <MudNumericField Typo="Typo.body2" T="int" Min="0" Max="100" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Outlined.Percent" IconSize="Size.Small" @bind-value="context.TaxPercentage" />
                </MudTd>
                <MudTd Class="align-right text-nowrap" DataLabel="@(Price.Label[nameof(Price.Quantity)])">
                    @* Todo: `AdornmentText`のサイズが、`Typo`の設定に従わない *@
                    <MudTextField Typo="Typo.body2" T="float?" Adornment="Adornment.End" AdornmentText="@(product?.Unit)" Validation="@(new Func<float?, IEnumerable<string>>(QuantityValidation))" @bind-Value="context.Quantity" />
                </MudTd>
                <MudTd DataLabel="@(Price.Label[nameof(Price.Remarks)])">
                    <MudTextField Typo="Typo.body2" T="string" @bind-Value="context.Remarks" Placeholder="@(Price.Label[nameof(Price.Remarks)])" />
                </MudTd>
            </RowEditingTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="_pageSizeOptions" InfoFormat="{first_item}-{last_item} / {all_items}" RowsPerPageString="行/頁:" />
            </PagerContent>
            <EditButtonContent Context="button">
                <MudTooltip Text="編集" Duration="1000">
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
                </MudTooltip>
            </EditButtonContent>
        </MudTable>
        <MudText Class="mt-2" Typo="Typo.body2" Color="Color.Success">@(DataSet.Valid ? "validated" : "")</MudText>
        <MudToolBar Dense Class="mb-2">
            @*hidden spacer*@
        </MudToolBar>
    } else {
        <MudText>No items found.</MudText>
    }
    <ItemListFooter TItem="Price" ShowAddButton="false">
        <MudSpacer />
        <MudButton Variant="Variant.Filled" OnClick="() => DataSet.TaxExcluded = !DataSet.TaxExcluded">
            @($"税{(DataSet.TaxExcluded ? "込" : "抜")}")
        </MudButton>
        <MudSpacer />
    </ItemListFooter>
}


@code{
    /// <summary>直上の行との比較用</summary>
    protected long lastCategoryId;

    /// <summary>直上の行との比較用</summary>
    protected long lastProductId;

    /// <summary>直上の行との比較用</summary>
    protected long lastStoreId;

    /// <summary>ページの変化検出用</summary>
    protected int lastPage;

    /// <inheritdoc/>
    protected override int _initialPageSizeIndex => 2;

    /// <summary>ページの変化を検出</summary>
    protected void CheckPageChangedAndCollapse () {
        if (_table != null && lastPage != _table.CurrentPage) {
            // グループをたたむ
            _table.CollapseAllGroups ();
            // 編集を終える
            _table.SetEditingItem (null);
            lastPage = _table.CurrentPage;
        }
    }

    /// <summary>行グループ</summary>
    protected TableGroupDefinition<Price> groupDefinition = new () {
        GroupName = "Product",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = false,
        Selector = i => i.ProductId
    };

    /// 同じ製品の価格を追加
    protected async Task AddSameItem (long productId, long storeId) {
        newItem = new (DataSet, productId, storeId);
        await base.AddItem ();
    }

    /// <summary>Quantityの検証</summary>
    protected IEnumerable<string> QuantityValidation (float? quantity) {
        if (quantity <= 0) {
            yield return $"{Price.Label [nameof (Price.Quantity)]} > 0";
        }
    }

    /// <summary>行毎の関係値を取得</summary>
    private (Category? category, Product? product, Store? Store) GetRelations (Price context) {
        var category = context.Category (DataSet);
        var product = context.Product (DataSet);
        var store = context.Store (DataSet);
        lastCategoryId = category?.Id ?? 0;
        lastProductId = product?.Id ?? 0;
        lastStoreId = store?.Id ?? 0;
        return (category, product, store);
    }

    /// <summary>編集で単価が有効になったら確認日時を設定</summary>
    protected override void Commit (object obj) {
        var item = GetT (obj);
        if (item.PriceWithTax != null && item.Quantity != null) {
            item.UnitPrice = item.PriceWithTax / item.Quantity;
            item.Confirmed = DateTime.Now;
        }
        base.Commit (obj);
    }

}
